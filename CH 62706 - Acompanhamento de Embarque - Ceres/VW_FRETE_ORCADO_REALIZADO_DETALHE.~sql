CREATE MATERIALIZED VIEW VW_FRETE_ORCADO_DETALHE REFRESH FORCE ON DEMAND START WITH SYSDATE NEXT SYSDATE + 10/24/60 AS
SELECT CS.SEQ_PLA_PED_VENDA,
       CS.NR_CONTRATO||'/'||CS.LETRA_CONTRATO AS CONTRATO,
       CS.COD_EMPRESA,
       CS.COD_SAFRA,
       CA.DOCUMENTO,
       ES.NR_DOCUMENTO,
       TRUNC(ES.DATA_EMISSAO) AS DATA_FATURAMENTO,
       EI.QUANTIDADE,
       LG.VALOR_TONELADA,
       DECODE((SELECT COUNT(LG2.SEQ_PLA_LIGA_FRETE) 
                 FROM AGRICOLA.EST_LIGA_FRETE_ROMANEIO LG2
                WHERE LG2.SEQ_PLA_FRETE = EF.SEQ_PLA_FRETE), 1 ,NVL(CA.VALOR_DOCUM,0),ROUND(LG.QUANTIDADE*(LG.VALOR_TONELADA/1000),2)) AS VLR_FRETE_REALIZADO

  FROM AGRICOLA.CONTRATO_SAIDA          CS,
       AGRICOLA.CONTRATO_DESMEMBRAMENTO CD,
       AGRICOLA.EST_SAIDAS              ES,
       AGRICOLA.EST_SAIDAS_ITENS        EI,
       AGRICOLA.EST_LIGA_FRETE_ROMANEIO LG,
       AGRICOLA.EST_FRETE_ROMANEIO      EF,
       AGRICOLA.CONTAS_PAGAR            CA

 WHERE CS.SEQ_PLA_PED_VENDA   = CD.SEQ_PLA_PED_VENDA
   AND CD.SEQ_PLA_CONT_DES    = ES.SEQ_PLA_CONT_DES
   AND ES.SEQ_PLA_SAIDA       = EI.SEQ_PLA_SAIDA    (+)
   AND ES.SEQ_PLA_SAIDA       = LG.SEQ_PLA_SAIDA    (+)
   AND LG.SEQ_PLA_FRETE       = EF.SEQ_PLA_FRETE    (+)
   AND EF.SEQ_PLA_PAGAR       = CA.SEQ_PLA_PAGAR    (+)
   AND NVL(CS.TIPO_FRETE,'E') = 'E'
   AND NVL(ES.CANCELADO, 'N') = 'N'
   AND TO_CHAR(TRUNC(CS.DATA_CONTRATO),'YYYYMM')    >= '200001'
