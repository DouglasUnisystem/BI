CREATE MATERIALIZED VIEW VW_BAIXAS_CONTRATO_VENDA REFRESH FORCE ON DEMAND START WITH SYSDATE NEXT SYSDATE + 5/24/60 AS
SELECT DE.SEQ_PLA_PED_VENDA,
       SUM(RO.PESO_BRUTO-RO.PESO_TARA) AS BAIXAS,
       SUM(DECODE(DE.PESO_ORIGEM_DESTINO,'D',DECODE(EC.SEQ_PLA_SAI_ITEM,NULL,NVL(SI.QUANTIDADE,0),NVL(EC.PESO_CHEGADA,0)),NVL(SI.QUANTIDADE,0))) AS BAIXA_LIQUIDO,
       (SUM(RO.DES_UMIDADE) + SUM(RO.DES_IMPUREZA) + SUM(RO.DES_AVARIADO) + SUM(RO.DES_ARDIDO) + SUM(RO.DES_OUTROS)) AS DESCONTOS
  FROM AGRICOLA.CONTRATO_DESMEMBRAMENTO DE,
       AGRICOLA.EST_SAIDAS              SA,
       AGRICOLA.EST_SAIDAS_ROM          RO,
       AGRICOLA.EST_PESO_CHEGADA        EC,
       AGRICOLA.EST_SAIDAS_ITENS        SI
 WHERE DE.SEQ_PLA_CONT_DES   = SA.SEQ_PLA_CONT_DES
   AND SA.SEQ_PLA_SAIDA      = RO.SEQ_PLA_SAIDA
   AND SI.SEQ_PLA_SAI_ITEM   = EC.SEQ_PLA_SAI_ITEM (+)
   AND SA.SEQ_PLA_SAIDA      = SI.SEQ_PLA_SAIDA    (+)
   AND NVL(RO.CANCELADO,'N') = 'N'
 GROUP BY DE.SEQ_PLA_PED_VENDA
