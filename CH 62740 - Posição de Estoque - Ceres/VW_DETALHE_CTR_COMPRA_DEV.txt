CREATE MATERIALIZED VIEW VW_DETALHE_CTR_COMPRA_DEV REFRESH FORCE ON DEMAND START WITH SYSDATE NEXT SYSDATE + 5/24/60 AS
SELECT EE.SEQ_PLA_SAIDA AS SEQ_PLA_ENTRADA,
       TRUNC(EE.DATA_SAIDA) DATA_ENTRADA,
       EE.NR_DOCUMENTO,
       ' ' AS ROMANEIO,
       TL.DESC_TIPO_LCTO,
       SUM(NVL(EI.QUANTIDADE,0))     QUANTIDADE,
       CASE WHEN SUM(NVL(EI.QUANTIDADE, 0)) > 0 THEN (AVG(EE.VALOR_TOTAL) / SUM(NVL(EI.QUANTIDADE, 0))) ELSE 0 END UNITARIO,
       AVG(EE.VALOR_TOTAL)           VALOR_TOTAL,
       SUM(NVL(EV.VALOR_FUNRURAL,0)) VALOR_FUNRURAL,
       SUM(NVL(EV.VALOR_SENAR,0))    VALOR_SENAR,
       SUM(NVL(EV.VALOR_RAT,0))      VALOR_RAT,
       SUM(NVL(EV.VALOR_FETHAB,0))   VALOR_FETHAB,
       SUM(NVL(EV.VALOR_FACS,0))     VALOR_FACS,
       (AVG(EE.VALOR_TOTAL)-SUM(NVL(EV.VALOR_FUNRURAL, 0)-NVL(EV.VALOR_FETHAB, 0)-NVL(EV.VALOR_IMAFIR, 0)-NVL(EV.VALOR_FACS, 0)-NVL(EV.VALOR_SENAR, 0))) VALOR_LIQUIDO,
       SUM(NVL(EV.VALOR_ICMS,0))     VALOR_ICMS,
       FI.SIGLA_FILIAL,
       TL.COD_TIPO_LCTO,
       SUM(0) QTDE_TOTAL,
       EE.NR_DOCUMENTO AS NR_DOCUMENTO_DEVOLUCAO,
       'S' AS DEVOLVIDO,
       SUM(NVL(EV.VALOR_IAGRO,0))  AS VALOR_IAGRO,
       SUM(NVL(EV.VALOR_IMAFIR,0)) AS VALOR_IMAFIR,
       SUM(0) AS QTD_NF,
       EE.SEQ_PLA_CONTRATO AS ID,
       ' ' AS SEQ_PLA_ORIGEM
  FROM AGRICOLA.EST_SAIDAS         EE,
       AGRICOLA.EST_SAIDAS_ITENS   EI,
       AGRICOLA.EST_SAIDAS_VALORES EV,
       AGRICOLA.FILIAIS            FI,
       AGRICOLA.TIPOS_LANCTOS      TL,
       AGRICOLA.CLIENTES_ENDERECOS CE
 WHERE EE.SEQ_PLA_SAIDA       = EI.SEQ_PLA_SAIDA
   AND EI.SEQ_PLA_SAI_ITEM    = EV.SEQ_PLA_SAI_ITEM
   AND EE.COD_EMPRESA         = FI.COD_EMPRESA
   AND EE.COD_TIPO_LCTO       = TL.COD_TIPO_LCTO
   AND EE.COD_FILIAL          = FI.COD_FILIAL
   AND EE.SEQ_PLA_ENDERECO    = CE.SEQ_PLA_ENDERECO
   AND NVL(EE.CANCELADO,'N')  = 'N'
   AND NVL(TL.DEVOLUCAO,'N')  = 'S'
 GROUP BY EE.SEQ_PLA_SAIDA,
       FI.SIGLA_FILIAL,
       TL.DESC_TIPO_LCTO,
       TL.COD_TIPO_LCTO,
       TRUNC(EE.DATA_SAIDA),
       EE.NR_DOCUMENTO,
       EE.COD_TIPO_LCTO,
       EE.SEQ_PLA_CONTRATO
