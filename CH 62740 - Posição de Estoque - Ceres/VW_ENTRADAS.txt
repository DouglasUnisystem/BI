CREATE MATERIALIZED VIEW VW_ENTRADAS REFRESH FORCE ON DEMAND START WITH SYSDATE NEXT SYSDATE + 5/24/60 AS
SELECT ET.SEQ_PLA_ENDERECO,
       SUM(DECODE(RE.PESO_BRUTO   ,NULL,0,RE.PESO_BRUTO)-
           DECODE(RE.PESO_TARA    ,NULL,0,RE.PESO_TARA)) AS PESO_BRUTO,
       SUM(DECODE(RE.DES_UMIDADE  ,NULL,0,RE.DES_UMIDADE)+
           DECODE(RE.DES_IMPUREZA ,NULL,0,RE.DES_IMPUREZA)+
           DECODE(RE.DES_AVARIADO ,NULL,0,RE.DES_AVARIADO)+
           DECODE(RE.DES_ARDIDO   ,NULL,0,RE.DES_ARDIDO)+
           DECODE(RE.DES_OUTROS   ,NULL,0,RE.DES_OUTROS)) AS DESCONTOS,
       SUM(DECODE(RE.DES_SERVICO  ,NULL,0,RE.DES_SERVICO)) AS DES_SERVICO,
       SUM(DECODE(EI.QUANTIDADE   ,NULL,0,EI.QUANTIDADE)) AS PESO_LIQUIDO,
       ET.COD_EMPRESA,
       ET.COD_FILIAL,
       ET.COD_SAFRA,
       EI.SEQ_PLA_ARMAZEM,
       EI.SEQ_PLA_PRODUTO,
       ET.DATA_EMISSAO AS DATA
  FROM AGRICOLA.EST_ENTRADAS       ET,
       AGRICOLA.EST_ENTRADAS_ROM   RE,
       AGRICOLA.EST_ENTRADAS_ITENS EI,
       AGRICOLA.PRODUTOS           PD,
       AGRICOLA.SUB_GRUPO          SG
 WHERE NVL(RE.CANCELADO,'N') <> 'S'
   AND ET.SEQ_PLA_ENTRADA   = RE.SEQ_PLA_ENTRADA   (+)
   AND RE.SEQ_PLA_ENTRADA   = EI.SEQ_PLA_ENTRADA   (+)
   AND EI.SEQ_PLA_PRODUTO   = PD.SEQ_PLA_PRODUTO   (+)
   AND PD.SEQ_PLA_SUB_GRUPO = SG.SEQ_PLA_SUB_GRUPO (+)
   AND RE.TIPO_ENTRADA      <> 'V'
   AND RE.TIPO_ENTRADA      <> 'D'
 GROUP BY ET.SEQ_PLA_ENDERECO, ET.COD_EMPRESA, ET.COD_FILIAL, ET.COD_SAFRA, EI.SEQ_PLA_ARMAZEM, EI.SEQ_PLA_PRODUTO, ET.DATA_EMISSAO;
