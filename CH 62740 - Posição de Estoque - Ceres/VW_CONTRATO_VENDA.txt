CREATE MATERIALIZED VIEW VW_CONTRATO_VENDA REFRESH FORCE ON DEMAND START WITH SYSDATE NEXT SYSDATE + 5/24/60 AS
SELECT CS.NR_CONTRATO,
       CS.LETRA_CONTRATO,
       CS.DATA_CONTRATO AS DATA,
       CL.NOME_CLIENTE AS CLIENTE_ENTREGA,
       CE.ENDERECO AS ENDERECO_ENTREGA,
       PD.DESCRICAO_PRODUTO,
       MO.SIGLA_MOEDA,
       ROUND(CS.VALOR_FRETE*CS.QUANTIDADE/1000,2) AS FRETE_TOTAL,
       UN.SIGLA_UNIDADE,
       NVL(BA.BAIXA_LIQUIDO,0) AS QTDE_EMBARCADO,
       NVL(BA.DESCONTOS,0) AS CTR_DESCONTOS,
       NVL(CS.QUANTIDADE,0)  - NVL(BA.BAIXA_LIQUIDO,0) + NVL(DV.DEVOLUCAO,0) AS SALDO_EMBARCAR,
       CS.FINALIZADO,
       CS.CANCELADO,
       CS.COD_EMPRESA,
       CS.COD_FILIAL,
       CS.COD_SAFRA
       ,DV.DEVOLUCAO_NF,
       DV.DEVOLUCAO,
       BA.BAIXA_LIQUIDO,
       BA.DESCONTOS,
       CS.SEQ_PLA_PED_VENDA AS ID,
       CS.QUANTIDADE,
       CS.PRECO_SACA AS UNITARIO,
       CS.VALOR_TOTAL,
       SF.DESCRICAO_SAFRA,
       EP.NOME_EMPRESA,
       FI.DESCRICAO_FILIAL,
       CS.SEQ_PLA_PRODUTO
  FROM AGRICOLA.CONTRATO_SAIDA          CS,
       AGRICOLA.PRODUTOS                PD,
       AGRICOLA.CLIENTES_ENDERECOS      CE,
       AGRICOLA.CLIENTES                CL,
       AGRICOLA.CIDADES                 CD,
       AGRICOLA.MOEDAS                  MO,
       AGRICOLA.UNIDADE_PRODUTO         UN,
       AGRICOLA.SAFRAS                  SF,
       AGRICOLA.EMPRESAS                EP,
       AGRICOLA.FILIAIS                 FI,
       --BAIXAS
       (SELECT SEQ_PLA_PED_VENDA,
               BAIXA_LIQUIDO,
               DESCONTOS
          FROM VW_BAIXAS_CONTRATO_VENDA) BA,
       --DEVOLUÇÃO
       (SELECT SEQ_PLA_PED_VENDA,
               DEVOLUCAO_NF,
               DEVOLUCAO
          FROM VW_DEVOLUCAO_CONTRATO_VENDA) DV
 WHERE CS.COD_SAFRA           = SF.COD_SAFRA
   AND CS.COD_EMPRESA         = EP.COD_EMPRESA
   AND CS.COD_FILIAL          = FI.COD_FILIAL
   AND EP.COD_EMPRESA         = FI.COD_EMPRESA
   AND CS.SEQ_PLA_UNIDADE     = UN.SEQ_PLA_UNIDADE  (+)
   AND CS.SEQ_PLA_PRODUTO     = PD.SEQ_PLA_PRODUTO
   AND CS.SEQ_PLA_END_ENTREGA = CE.SEQ_PLA_ENDERECO
   AND CE.SEQ_PLA_CLIENTE     = CL.SEQ_PLA_CLIENTE
   AND CE.SEQ_PLA_CIDADES     = CD.SEQ_PLA_CIDADES  (+)
   AND CS.SEQ_PLA_MOEDA       = MO.SEQ_PLA_MOEDA    (+)
   AND CS.SEQ_PLA_PED_VENDA   = BA.SEQ_PLA_PED_VENDA(+)
   AND CS.SEQ_PLA_PED_VENDA   = DV.SEQ_PLA_PED_VENDA(+)
