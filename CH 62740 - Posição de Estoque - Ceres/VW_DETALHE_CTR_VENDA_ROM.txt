CREATE MATERIALIZED VIEW VW_DETALHE_CTR_VENDA_ROM REFRESH FORCE ON DEMAND START WITH SYSDATE NEXT SYSDATE + 5/24/60 AS
SELECT FIL.SIGLA_FILIAL,
       TRUNC(ES.DATA_EMISSAO) DATA_EMISSAO,
       ES.NR_DOCUMENTO,
       SUM(NVL(ESI.QUANTIDADE,0)) QUANTIDADE,
       CASE WHEN SUM(NVL(ESI.QUANTIDADE, 0)) > 0 THEN (AVG(NVL(ES.VALOR_TOTAL,0)) / SUM(NVL(ESI.QUANTIDADE, 0))) ELSE 0 END UNITARIO,
       AVG(NVL(ES.VALOR_TOTAL,0)) VALOR_TOTAL,
       NVL((AVG(ES.VALOR_TOTAL)-SUM(NVL(ESV.VALOR_FUNRURAL, 0) + NVL(ESV.VALOR_SENAR, 0) + NVL(ESV.VALOR_FETHAB, 0) + NVL(ESV.VALOR_IMAFIR, 0) + NVL(ESV.VALOR_FACS, 0) + NVL(ESV.VALOR_RAT, 0) + NVL(ESV.VALOR_IAGRO,0) )),0) VALOR_LIQUIDO,
       SUM(NVL(ESV.VALOR_FUNRURAL, 0)) VALOR_FUNRURAL,
       SUM(NVL(ESV.VALOR_SENAR,0)) VALOR_SENAR,
       SUM(NVL(ESV.VALOR_RAT,0)) VALOR_RAT,
       SUM(NVL(ESV.VALOR_FETHAB, 0)) VALOR_FETHAB,
       SUM(NVL(ESV.VALOR_FACS, 0)) VALOR_FACS,
       SUM(NVL(ESV.VALOR_IAGRO,0)) VALOR_IAGRO,
       SUM(NVL(ESV.VALOR_ICMS, 0)) VALOR_ICMS,
       ES.COD_TIPO_LCTO,
       ROM.NR_ROMANEIO,
       NVL(ER.DEVOLVIDO,'N') AS DEVOLVIDO,
       ' ' AS NR_DOCUMENTO_DEVOLUCAO,
       SUM(NVL(ESI.QUANTIDADE,0)) AS QTD_NOTA,
       SUM(NVL(ER.PESO_BRUTO-ER.PESO_TARA,0)) AS QTDE_TOTAL,
       NVL(ROUND(LF.QUANTIDADE*(LF.VALOR_TONELADA/1000),2),0) AS VALOR_FRETE,
       SUM(NVL(ESV.VALOR_IMAFIR, 0)) AS VALOR_IMAFIR,
       SUM((NVL(ER.PESO_BRUTO,0)-NVL(ER.PESO_TARA,0)) - NVL(ER.DES_UMIDADE,0) - NVL(ER.DES_IMPUREZA,0) - NVL(ER.DES_AVARIADO,0) - NVL(ER.DES_ARDIDO,0) - NVL(ER.DES_OUTROS,0)) AS QTDE_LIQUIDA,
       SUM(NVL(EC.PESO_CHEGADA,0)) AS PESO_CHEGADA,
       ES.SEQ_PLA_ORIGEM AS ID
  FROM AGRICOLA.EST_SAIDAS              ES,
       AGRICOLA.EST_SAIDAS_ITENS        ESI,
       AGRICOLA.EST_SAIDAS_VALORES      ESV,
       AGRICOLA.FILIAIS                 FIL,
       AGRICOLA.CLIENTES_ENDERECOS      CE,
       AGRICOLA.EST_SAIDAS_ROM          ER,
       AGRICOLA.EST_PESO_CHEGADA        EC,
       AGRICOLA.EST_LIGA_FRETE_ROMANEIO LF,
       (SELECT R.NR_ROMANEIO,
               R.SEQ_PLA_SAIDA
          FROM AGRICOLA.EST_SAIDAS_ROM R) ROM
 WHERE ES.SEQ_PLA_SAIDA        = ESI.SEQ_PLA_SAIDA
   AND ESI.SEQ_PLA_SAI_ITEM    = ESV.SEQ_PLA_SAI_ITEM
   AND ES.COD_FILIAL           = FIL.COD_FILIAL
   AND ES.COD_EMPRESA          = FIL.COD_EMPRESA
   AND ES.SEQ_PLA_ENDERECO     = CE.SEQ_PLA_ENDERECO
   AND ES.SEQ_PLA_SAIDA        = ER.SEQ_PLA_SAIDA    (+)
   AND ESI.SEQ_PLA_SAI_ITEM    = EC.SEQ_PLA_SAI_ITEM (+)
   AND NVL(ES.CANCELADO,'N')   = 'N'
   AND ES.NUM_CONTRATO IS NOT NULL
   AND ES.SEQ_PLA_SAIDA        = LF.SEQ_PLA_SAIDA (+)
   AND ES.SEQ_PLA_SAIDA        = ROM.SEQ_PLA_SAIDA(+)
 GROUP BY FIL.SIGLA_FILIAL,
          TRUNC(ES.DATA_EMISSAO),
          ES.NR_DOCUMENTO,
          ES.COD_TIPO_LCTO,
          ES.SEQ_PLA_SAIDA,
          NVL(ER.DEVOLVIDO,'N'),
          ROUND(LF.QUANTIDADE*(LF.VALOR_TONELADA/1000),2),
          ES.SEQ_PLA_ORIGEM,
          ROM.NR_ROMANEIO;
