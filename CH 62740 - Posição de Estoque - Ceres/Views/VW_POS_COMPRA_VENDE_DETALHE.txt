CREATE OR REPLACE VIEW VW_POS_COMPRA_VENDE_DETALHE AS
SELECT CL.NOME_CLIENTE AS NOME_COMPRA_VENDE,
       MO.SIGLA_MOEDA  AS SIGLA_MOEDA_COMPRA_VENDE,
       EC.PRECO_SACA   AS VLR_UNITARIO_COMPRA_VENDE,
       EC.QUANTIDADE   AS QTDE_COMPRA_VENDE,
       TO_CHAR(EC.NR_CONTRATO) AS NR_CONTRATO,
       EP.NOME_EMPRESA,
       EP.SIGLA_EMPRESA,
       SF.DESCRICAO_SAFRA,
       FI.DESCRICAO_FILIAL,
       EC.DATA_COMPRA AS DATA,
       AR.SIGLA_ARMAZEM,
       AR.DESC_ARMAZEM,
       PD.DESCRICAO_PRODUTO,
       EC.COD_EMPRESA,
       EC.COD_FILIAL,
       EC.COD_SAFRA,
       EC.SEQ_PLA_PRODUTO,
       AR.SEQ_PLA_ARMAZEM,
       'COMPRA' AS TIPO
  FROM CERES2311.EST_COMPRA_ANTECIPADA EC,
       CERES2311.CLIENTES              CL,
       CERES2311.CLIENTES_ENDERECOS    CE,
       CERES2311.MOEDAS                MO,
       CERES2311.EMPRESAS              EP,
       CERES2311.SAFRAS                SF,
       CERES2311.FILIAIS               FI,
       CERES2311.ARMAZENS              AR,
       CERES2311.PRODUTOS              PD
 WHERE EC.SEQ_PLA_END_ORIGEM = CE.SEQ_PLA_ENDERECO
   AND CE.SEQ_PLA_CLIENTE    = CL.SEQ_PLA_CLIENTE
   AND EC.SEQ_PLA_MOEDA      = MO.SEQ_PLA_MOEDA
   AND NVL(EC.CANCELADO,'N') = 'N'
   AND EC.COD_EMPRESA        = EP.COD_EMPRESA
   AND EC.COD_FILIAL         = FI.COD_FILIAL
   AND EP.COD_EMPRESA        = FI.COD_EMPRESA
   AND EC.COD_SAFRA          = SF.COD_SAFRA
   AND EC.SEQ_PLA_ARMAZEM    = AR.SEQ_PLA_ARMAZEM
   AND EC.SEQ_PLA_PRODUTO    = PD.SEQ_PLA_PRODUTO
UNION ALL
--COMPRA
SELECT CL.NOME_CLIENTE    AS NOME_COMPRA_VENDE,
       MO.SIGLA_MOEDA     AS SIGLA_MOEDA_COMPRA_VENDE,
       CC.PRECO_SACA      AS VLR_UNITARIO_COMPRA_VENDE,
       SUM(CD.QUANTIDADE) AS QTDE_COMPRA_VENDE,
       CC.NR_CONTRATO,
       EP.NOME_EMPRESA,
       EP.SIGLA_EMPRESA,
       SF.DESCRICAO_SAFRA,
       FI.DESCRICAO_FILIAL,
       CC.DATA_CONTRATO AS DATA,
       AR.SIGLA_ARMAZEM,
       AR.DESC_ARMAZEM,
       PD.DESCRICAO_PRODUTO,
       CC.COD_EMPRESA,
       CC.COD_FILIAL,
       CC.COD_SAFRA,
       CC.SEQ_PLA_PRODUTO,
       AR.SEQ_PLA_ARMAZEM,
       'COMPRA' AS TIPO
  FROM CERES2311.COMPRA_CONTRATO         CC,
       CERES2311.COMPRA_DESMEMBRAMENTO   CD,
       CERES2311.CLIENTES                CL,
       CERES2311.CLIENTES_ENDERECOS      CE,
       CERES2311.MOEDAS                  MO,
       CERES2311.EMPRESAS                EP,
       CERES2311.SAFRAS                  SF,
       CERES2311.FILIAIS                 FI,
       CERES2311.ARMAZENS                AR,
       CERES2311.PRODUTOS                PD
 WHERE CC.SEQ_PLA_CTR_COMPRA     = CD.SEQ_PLA_CTR_COMPRA
   AND CC.SEQ_PLA_END_PROD_COMPR = CE.SEQ_PLA_ENDERECO
   AND CE.SEQ_PLA_CLIENTE        = CL.SEQ_PLA_CLIENTE
   AND CC.SEQ_PLA_MOEDA          = MO.SEQ_PLA_MOEDA
   AND NVL(CC.CANCELADO,'N')     = 'N'
   AND CC.COD_EMPRESA            = EP.COD_EMPRESA
   AND CC.COD_FILIAL             = FI.COD_FILIAL
   AND EP.COD_EMPRESA            = FI.COD_EMPRESA
   AND CC.COD_SAFRA              = SF.COD_SAFRA
   AND CD.SEQ_PLA_ARMAZEM        = AR.SEQ_PLA_ARMAZEM
   AND CC.SEQ_PLA_PRODUTO        = PD.SEQ_PLA_PRODUTO
 GROUP BY CD.SEQ_PLA_ARMAZEM,
          CL.NOME_CLIENTE,
          CC.DATA_CONTRATO,
          MO.SIGLA_MOEDA,
          CC.PRECO_SACA,
          CC.NR_CONTRATO,
          EP.NOME_EMPRESA,
          SF.DESCRICAO_SAFRA,
          FI.DESCRICAO_FILIAL,
          EP.SIGLA_EMPRESA,
          CC.DATA_CONTRATO,
          AR.SIGLA_ARMAZEM,
          PD.DESCRICAO_PRODUTO,
          AR.DESC_ARMAZEM,
          CC.COD_EMPRESA,
          CC.COD_FILIAL,
          CC.COD_SAFRA,
          CC.SEQ_PLA_PRODUTO,
          AR.SEQ_PLA_ARMAZEM
--VENDA
 UNION ALL
SELECT
       CL.NOME_CLIENTE    AS NOME_COMPRA_VENDE,
       MO.SIGLA_MOEDA     AS SIGLA_MOEDA_COMPRA_VENDE,
       CS.PRECO_SACA      AS VLR_UNITARIO_COMPRA_VENDE,
       SUM(CD.QUANTIDADE) AS QTDE_COMPRA_VENDE,
       TO_CHAR(CS.NR_CONTRATO) AS NR_CONTRATO,
       EP.NOME_EMPRESA,
       EP.SIGLA_EMPRESA,
       SF.DESCRICAO_SAFRA,
       FI.DESCRICAO_FILIAL,
       CS.DATA_CONTRATO AS DATA,
       AR.SIGLA_ARMAZEM,
       AR.DESC_ARMAZEM,
       PD.DESCRICAO_PRODUTO,
       CS.COD_EMPRESA,
       CS.COD_FILIAL,
       CS.COD_SAFRA,
       CS.SEQ_PLA_PRODUTO,
       AR.SEQ_PLA_ARMAZEM,
       'VENDA' AS TIPO
       --
  FROM CERES2311.CONTRATO_SAIDA          CS,
       CERES2311.CONTRATO_DESMEMBRAMENTO CD,
       CERES2311.CLIENTES                CL,
       CERES2311.CLIENTES_ENDERECOS      CE,
       CERES2311.MOEDAS                  MO,
       CERES2311.EMPRESAS                EP,
       CERES2311.SAFRAS                  SF,
       CERES2311.FILIAIS                 FI,
       CERES2311.ARMAZENS                AR,
       CERES2311.PRODUTOS                PD
 WHERE CS.SEQ_PLA_PED_VENDA   = CD.SEQ_PLA_PED_VENDA
   AND CS.SEQ_PLA_END_ENTREGA = CE.SEQ_PLA_ENDERECO
   AND CE.SEQ_PLA_CLIENTE     = CL.SEQ_PLA_CLIENTE
   AND CS.SEQ_PLA_MOEDA       = MO.SEQ_PLA_MOEDA
   AND CS.COD_EMPRESA         = EP.COD_EMPRESA
   AND CS.COD_SAFRA           = SF.COD_SAFRA
   AND CS.COD_FILIAL          = FI.COD_FILIAL
   AND EP.COD_EMPRESA         = FI.COD_EMPRESA
   AND CD.SEQ_PLA_ARMAZEM     = AR.SEQ_PLA_ARMAZEM
   AND CS.SEQ_PLA_PRODUTO     = PD.SEQ_PLA_PRODUTO
   AND NVL(CS.CANCELADO,'N') = 'N'
 GROUP BY CL.NOME_CLIENTE,
          MO.SIGLA_MOEDA,
          CS.PRECO_SACA,
          CS.NR_CONTRATO,
          EP.NOME_EMPRESA,
          EP.SIGLA_EMPRESA,
          SF.DESCRICAO_SAFRA,
          FI.DESCRICAO_FILIAL,
          CS.DATA_CONTRATO,
          AR.SIGLA_ARMAZEM,
          AR.DESC_ARMAZEM,
          PD.DESCRICAO_PRODUTO,
          CS.COD_EMPRESA,
          CS.COD_FILIAL,
          CS.COD_SAFRA,
          CS.SEQ_PLA_PRODUTO,
          AR.SEQ_PLA_ARMAZEM;
