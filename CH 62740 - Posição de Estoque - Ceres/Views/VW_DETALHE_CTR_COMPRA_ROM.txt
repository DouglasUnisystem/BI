CREATE OR REPLACE VIEW VW_DETALHE_CTR_COMPRA_ROM AS
SELECT EET.SEQ_PLA_ENTRADA,
       EET.DATA_ENTRADA,
       EET.NR_DOCUMENTO,
       '' AS NR_ROMANEIO,
       TLC.DESC_TIPO_LCTO,
       SUM(NVL(EEI.QUANTIDADE,0)) AS QUANTIDADE,
       ROUND(SUM(NVL(EEI.VALOR_TOTAL,0))/SUM(NVL(EEI.QUANTIDADE,0)),4) AS UNITARIO,
       SUM(NVL(EEI.VALOR_TOTAL,0))    AS VALOR_TOTAL,
       SUM(NVL(EEV.VALOR_FUNRURAL,0)) AS VALOR_FUNRURAL,
       SUM(NVL(EEV.VALOR_SENAR,0))    AS VALOR_SENAR,
       SUM(NVL(EEV.VALOR_RAT,0))      AS VALOR_RAT,
       SUM(NVL(EEV.VALOR_FETHAB,0))   AS VALOR_FETHAB,
       SUM(NVL(EEV.VALOR_FACS,0))     AS VALOR_FACS,
       SUM(NVL(EEI.VALOR_TOTAL,0) - NVL(EEV.VALOR_FUNRURAL,0) - NVL(EEV.VALOR_SENAR,0) -
         NVL(EEV.VALOR_RAT,0) - NVL(EEV.VALOR_FETHAB,0) - NVL(EEV.VALOR_IMAFIR,0) - NVL(EEV.VALOR_FACS,0) - NVL(EEV.VALOR_ICMS,0)) AS VALOR_LIQUIDO,
       SUM(NVL(EEV.VALOR_ICMS,0))     AS VALOR_ICMS,
       FIL.SIGLA_FILIAL,
       TLC.COD_TIPO_LCTO,
       SUM(EER.PESO_BRUTO - EER.PESO_TARA) AS QTDE_TOTAL,
       DV.NR_DOCUMENTO AS NR_DOCUMENTO_DEVOLUCAO,
       DECODE(DV.NR_DOCUMENTO,NULL,'N','S') AS DEVOLVIDO,
       SUM(NVL(EEV.VALOR_IAGRO,0))  AS VALOR_IAGRO,
       SUM(NVL(EEV.VALOR_IMAFIR,0)) AS VALOR_IMAFIR,
       SUM(NVL(EER.QTD_ORIGEM,0))   AS QTD_NF,
       CDE.SEQ_PLA_CTR_COMPRA AS ID,
       '' AS SEQ_PLA_ORIGEM
  FROM CERES2311.COMPRA_DESMEMBRAMENTO  CDE,
       CERES2311.EST_LIGA_CPR_ENTRADA   LGE,
       CERES2311.EST_LIGA_NOTA_ROMANEIO LNR,
       CERES2311.EST_ENTRADAS           EET,
       CERES2311.EST_ENTRADAS_ITENS     EEI,
       CERES2311.EST_ENTRADAS_VALORES   EEV,
       CERES2311.TIPOS_LANCTOS          TLC,
       CERES2311.FILIAIS                FIL,
       CERES2311.EST_ENTRADAS_ROM       EER,
       CERES2311.CLIENTES_ENDERECOS     CEE,
       (SELECT LR.SEQ_PLA_ENT_ITEM,
               EE.NR_DOCUMENTO
          FROM CERES2311.EST_SAIDAS       EE,
               CERES2311.EST_SAIDAS_ITENS EI,
               CERES2311.LIGA_NF_RETORNO  LR
         WHERE EE.SEQ_PLA_SAIDA    = EI.SEQ_PLA_SAIDA
           AND LR.SEQ_PLA_SAI_ITEM = EI.SEQ_PLA_SAI_ITEM) DV
 WHERE CDE.SEQ_PLA_CONT_DES   = LGE.SEQ_PLA_CTR_DES
   AND LGE.SEQ_PLA_ENTRADA    = LNR.SEQ_PLA_ROMANEIO
   AND LNR.SEQ_PLA_NOTA       = EET.SEQ_PLA_ENTRADA
   AND EET.SEQ_PLA_ENTRADA    = EEI.SEQ_PLA_ENTRADA
   AND EEI.SEQ_PLA_ENT_ITEM   = EEV.SEQ_PLA_ENT_ITEM (+)
   AND EET.COD_TIPO_LCTO      = TLC.COD_TIPO_LCTO
   AND EET.COD_FILIAL         = FIL.COD_FILIAL
   AND EET.COD_EMPRESA        = FIL.COD_EMPRESA
   AND LNR.SEQ_PLA_ROMANEIO   = EER.SEQ_PLA_ENTRADA
   AND EEI.SEQ_PLA_ENT_ITEM   = DV.SEQ_PLA_ENT_ITEM  (+)
   AND EET.SEQ_PLA_ENDERECO   = CEE.SEQ_PLA_ENDERECO
 GROUP BY EET.SEQ_PLA_ENTRADA,
          EET.DATA_ENTRADA,
          EET.NR_DOCUMENTO,
          TLC.DESC_TIPO_LCTO,
          FIL.SIGLA_FILIAL,
          TLC.COD_TIPO_LCTO,
          DV.NR_DOCUMENTO,
          CDE.SEQ_PLA_CTR_COMPRA
