CREATE OR REPLACE VIEW VW_DEVOLUCAO_CONTRATO_VENDA AS
SELECT CTR2.SEQ_PLA_PED_VENDA,
       SUM(ETI.QUANTIDADE) AS DEVOLUCAO_NF,
       DECODE(SUM(NVL(ESR.PESO_BRUTO,0) - NVL(ESR.PESO_TARA,0)), 0, SUM(ETI.QUANTIDADE), SUM(NVL(ESR.PESO_BRUTO,0) - NVL(ESR.PESO_TARA,0))) AS DEVOLUCAO
  FROM CERES2311.CONTRATO_DESMEMBRAMENTO CTR2,
       CERES2311.EST_ENTRADAS            EET,
       CERES2311.EST_ENTRADAS_ITENS      ETI,
       CERES2311.LIGA_NF_RETORNO         LIG,
       CERES2311.EST_SAIDAS_ITENS        ESI,
       CERES2311.EST_SAIDAS_ROM          ESR
 WHERE EET.SEQ_PLA_ENTRADA     = ETI.SEQ_PLA_ENTRADA
   AND ETI.SEQ_PLA_ENT_ITEM    = LIG.SEQ_PLA_ENT_ITEM    (+)
   AND LIG.SEQ_PLA_SAI_ITEM    = ESI.SEQ_PLA_SAI_ITEM    (+)
   AND ESI.SEQ_PLA_SAIDA       = ESR.SEQ_PLA_SAIDA       (+)
   AND DECODE(EET.CANCELADO,NULL,'N',EET.CANCELADO) <> 'S'
   AND CTR2.SEQ_PLA_CONT_DES   = EET.SEQ_PLA_CTR_RETORNO (+)
 GROUP BY CTR2.SEQ_PLA_PED_VENDA