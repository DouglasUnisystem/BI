CREATE OR REPLACE VIEW VW_DETALHE_CTR_COMPRA_ENT AS
SELECT EE.SEQ_PLA_ENTRADA,
       TRUNC(EE.DATA_ENTRADA) DATA_ENTRADA,
       EE.NR_DOCUMENTO,
       '' AS ROMANEIO,
       TL.DESC_TIPO_LCTO,
       SUM(NVL(EI.QUANTIDADE, 0))    QUANTIDADE,
       CASE WHEN SUM(NVL(EI.QUANTIDADE, 0)) > 0 THEN (AVG(EE.VALOR_TOTAL) / SUM(NVL(EI.QUANTIDADE, 0))) ELSE 0 END UNITARIO,
       AVG(EE.VALOR_TOTAL)    VALOR_TOTAL,
       SUM(NVL(EV.VALOR_FUNRURAL, 0)) VALOR_FUNRURAL,
       SUM(NVL(EV.VALOR_SENAR, 0)) VALOR_SENAR,
       SUM(NVL(EV.VALOR_RAT, 0)) VALOR_RAT,
       SUM(NVL(EV.VALOR_FETHAB, 0)) VALOR_FETHAB,
       SUM(NVL(EV.VALOR_FACS, 0)) VALOR_FACS,
       (AVG(EE.VALOR_TOTAL)-SUM(NVL(EV.VALOR_FUNRURAL, 0)-NVL(EV.VALOR_FETHAB, 0)-NVL(EV.VALOR_IMAFIR, 0)-NVL(EV.VALOR_FACS, 0)-NVL(EV.VALOR_SENAR, 0))) VALOR_LIQUIDO,
       SUM(NVL(EV.VALOR_ICMS, 0)) VALOR_ICMS,
       FI.SIGLA_FILIAL,
       TL.COD_TIPO_LCTO,
       SUM(0)    QTDE_TOTAL,
       DV.NR_DOCUMENTO AS NR_DOCUMENTO_DEVOLUCAO,
       DECODE(DV.NR_DOCUMENTO,NULL,'N','S') AS DEVOLVIDO,
       SUM(NVL(EV.VALOR_IAGRO,0))     AS VALOR_IAGRO,
       SUM(NVL(EV.VALOR_IMAFIR,0))    AS VALOR_IMAFIR,
       SUM(0) AS QTD_NF,
       EE.SEQ_PLA_CTR_RETORNO AS ID,
       EE.SEQ_PLA_ORIGEM
  FROM CERES2311.EST_ENTRADAS         EE,
       CERES2311.EST_ENTRADAS_ITENS   EI,
       CERES2311.EST_ENTRADAS_VALORES EV,
       CERES2311.FILIAIS              FI,
       CERES2311.TIPOS_LANCTOS        TL,
       CERES2311.CLIENTES_ENDERECOS   CE,
       (SELECT LR.SEQ_PLA_ENT_ITEM,
               EE.NR_DOCUMENTO
          FROM CERES2311.EST_SAIDAS       EE,
               CERES2311.EST_SAIDAS_ITENS EI,
               CERES2311.LIGA_NF_RETORNO  LR
         WHERE EE.SEQ_PLA_SAIDA    = EI.SEQ_PLA_SAIDA
           AND LR.SEQ_PLA_SAI_ITEM = EI.SEQ_PLA_SAI_ITEM) DV
 WHERE EE.SEQ_PLA_ENTRADA  = EI.SEQ_PLA_ENTRADA
   AND EI.SEQ_PLA_ENT_ITEM = EV.SEQ_PLA_ENT_ITEM
   AND EE.COD_EMPRESA      = FI.COD_EMPRESA
   AND EE.COD_TIPO_LCTO    = TL.COD_TIPO_LCTO
   AND EE.COD_FILIAL       = FI.COD_FILIAL
   AND EE.SEQ_PLA_ENDERECO = CE.SEQ_PLA_ENDERECO
   AND EI.SEQ_PLA_ENT_ITEM = DV.SEQ_PLA_ENT_ITEM  (+)
   AND EE.FORM_LANCAMENTO  = 'DFMNFENTRADA'
 GROUP BY EE.SEQ_PLA_ENTRADA,
       FI.SIGLA_FILIAL,
       TL.DESC_TIPO_LCTO,
       TL.COD_TIPO_LCTO,
       TRUNC(EE.DATA_ENTRADA),
       EE.NR_DOCUMENTO,
       EE.COD_TIPO_LCTO,
       DV.NR_DOCUMENTO,
       EE.SEQ_PLA_CTR_RETORNO,
       EE.SEQ_PLA_ORIGEM;
