CREATE MATERIALIZED VIEW VW_GRAFICO_MOV_SEMENTES
REFRESH FORCE ON DEMAND
START WITH SYSDATE NEXT SYSDATE + 5/24/60 
AS
SELECT CL.SIGLA_CLASSE AS CATEGORIA,
       CL.SEQ_PLA_CLASSE,
       PR.SEQ_PLA_PRODUTO,
       UN.SEQ_PLA_UNIDADE,
       UN.SIGLA_UNIDADE,
       UN.QTDE_UNIDADE,
       CV.SEQ_PLA_PENEIRA,
       VR.SEQ_PLA_VARIEDADE,
       NVL(TV.TOTAL_VENDIDO,0) AS EMBARQUE,
       MP.DESCRICAO_MARCA,
       CV.SIGLA_PENEIRA AS PENEIRA,
       VR.DESC_VARIEDADE AS VARIEDADE,
       TCC.SEQ_PLA_TIPO_CULT,
       TCC.DESC_CULTURA  AS CULTURA,
       EMP.SIGLA_EMPRESA,
       CV.COD_EMPRESA,
       CV.COD_FILIAL,
       CV.COD_SAFRA,
       FIL.SIGLA_FILIAL,
       SAF.DESCRICAO_SAFRA AS SAFRA,
       UN.SIGLA_UNIDADE AS SIGLA_UNID_BASE,
       UN.QTDE_UNIDADE AS QTDE_UNID_BASE,
       NVL(TP.TOTAL_PRODUZIDO,0) +
       NVL(TC.TOTAL_COMPRADO,0)   -
       NVL(TP.QTD_SACAS_AVARIADAS,0) -
       NVL(TV.QUANTIDADE_ACERTO,0)-
       NVL(TE.TOTAL_ENTREGUE,0)+
       NVL(DV.QTDE_DEVOLVIDO,0) AS VOL_TOTAL_DISPONIVEL,
       NVL(TP.TOTAL_PRODUZIDO,0)                              AS VOL_TOTAL_PRODUZIDO,
       NVL(TC.TOTAL_COMPRADO,0)                               AS VOL_TOTAL_COMPRADO,
       NVL(TV.TOTAL_VENDIDO,0)                                AS VOL_TOTAL_VENDIDO,
       NVL(DV.QTDE_DEVOLVIDO,0)                               AS VOL_TOTAL_DEVOLVIDO,
       (UN.QTDE_UNIDADE*NVL(TP.TOTAL_PRODUZIDO,0)) +
       (UN.QTDE_UNIDADE*NVL(TC.TOTAL_COMPRADO,0))   -
       (UN.QTDE_UNIDADE*NVL(TP.QTD_SACAS_AVARIADAS,0)) -
       (UN.QTDE_UNIDADE*NVL(TV.QUANTIDADE_ACERTO,0))-
       (UN.QTDE_UNIDADE*NVL(TE.TOTAL_ENTREGUE,0))+
       (UN.QTDE_UNIDADE*NVL(DV.QTDE_DEVOLVIDO,0)) AS TOTAL_DISPONIVEL_KG,
       (UN.QTDE_UNIDADE*NVL(TP.TOTAL_PRODUZIDO,0)) +
       (UN.QTDE_UNIDADE*NVL(TC.TOTAL_COMPRADO,0))   -
       (UN.QTDE_UNIDADE*NVL(TP.QTD_SACAS_AVARIADAS,0)) -
       (UN.QTDE_UNIDADE*NVL(TV.QUANTIDADE_ACERTO,0))-
       (UN.QTDE_UNIDADE*NVL(TE.TOTAL_ENTREGUE,0))+
       (UN.QTDE_UNIDADE*NVL(DV.QTDE_DEVOLVIDO,0))  AS SALDO_VENDER_KG,
       (UN.QTDE_UNIDADE*NVL(TP.TOTAL_PRODUZIDO,0)) AS TOTAL_PRODUZIDO_KG,
       (UN.QTDE_UNIDADE*NVL(TC.TOTAL_COMPRADO,0)) AS TOTAL_COMPRADO_KG,
       (UN.QTDE_UNIDADE*NVL(TV.TOTAL_VENDIDO,0) ) AS TOTAL_VENDIDO_KG,
       (UN.QTDE_UNIDADE*NVL(DV.QTDE_DEVOLVIDO,0)) AS TOTAL_DEVOLVIDO_KG,
        (UN.QTDE_UNIDADE*NVL(TV.TOTAL_VENDIDO,0)) - (UN.QTDE_UNIDADE*NVL(TE.TOTAL_ENTREGUE,0)) AS SALDO_ENTREGAR_KG,
       0 AS VOL_TOTAL_ENT_TRANSF,
       NVL(TR.TOTAL_RESERVADO,0) AS VOL_TOTAL_RESERVAS,
       0 AS VOL_TOTAL_RESERVAS_UTS,
       0 AS VOL_TOTAL_PRE_BENEFICIAMENTO,
       0 AS VOL_TOTAL_TRATADO,
       NVL(TV.TOTAL_VENDIDO,0) - NVL(TE.TOTAL_ENTREGUE,0) AS VOL_SALDO_ENTREGAR,
       NVL(TE.TOTAL_ENTREGUE,0) AS VOL_TOTAL_ENTREGUE,
       0 AS VOL_TOTAL_SAI_TRATAMENTO,
       NVL(TP.QTD_SACAS_AVARIADAS,0) AS VOL_TOTAL_SAI_DESCARTE
  FROM (SELECT CV.COD_EMPRESA,
               CV.COD_FILIAL,
               CV.COD_SAFRA,
               CV.SEQ_PLA_PRODUTO,
               CV.SEQ_PLA_UNIDADE,
               CV.SEQ_PLA_VARIEDADE,
               CV.SEQ_PLA_CLASSE,
               CV.SEQ_PLA_CULTIVAR,
               PN.SEQ_PLA_PENEIRA,
               PN.DESC_PENEIRA,
               PN.SIGLA_PENEIRA
          FROM BANCO.UBS_CULTIVAR CV, BANCO.UBS_PENEIRAS PN)  CV,
       BANCO.PRODUTOS        PR,
       BANCO.UNIDADE_PRODUTO UN,
       BANCO.UNIDADE_PRODUTO UNKG,--So Funciona quando so houver somente uma unidade KG criada no banco... O que deveria ser obvio..ne, assim esperamos
       BANCO.UBS_VARIEDADES  VR,
       BANCO.UBS_CLASSES     CL,
       BANCO.EMPRESAS        EMP,
       BANCO.FILIAIS         FIL,
       BANCO.SAFRAS          SAF,
       BANCO.TIPO_CULTURA    TCC,
       BANCO.MARCA_PRODUTO   MP,
       (SELECT LT.SEQ_PLA_CULTIVAR,
               LT.SEQ_PLA_PENEIRA,
               SUM(NVL(EL.QUANTIDADE,0)) AS TOTAL_SAIDA_PENEIRA
          FROM BANCO.EST_SAIDAS_LOTES EL,
               BANCO.EST_SAIDAS_ITENS EI,
               BANCO.EST_SAIDAS       ES,
               BANCO.UBS_LOTES        LT
         WHERE EL.SEQ_PLA_SAI_ITEM   = EI.SEQ_PLA_SAI_ITEM
           AND EI.SEQ_PLA_SAIDA      = ES.SEQ_PLA_SAIDA
           AND EL.SEQ_PLA_LOTES      = LT.SEQ_PLA_LOTES
           AND ES.FORM_LANCAMENTO    = 'DFMNOTASAIDA'
           AND DECODE(ES.NR_AUTORIZA,NULL,'X',ES.NR_AUTORIZA) <> 'X'
           AND DECODE(ES.CANCELADO  ,NULL,'X',ES.CANCELADO) <> 'S'
       GROUP BY LT.SEQ_PLA_CULTIVAR,LT.SEQ_PLA_PENEIRA ) TSP,
        (SELECT LT.SEQ_PLA_CULTIVAR,
                LT.SEQ_PLA_PENEIRA,
                SUM(NVL(EL.QUANTIDADE,0)) AS QTDE_DEVOLVIDO
           FROM BANCO.UBS_LOTES          LT,
                BANCO.EST_ENTRADAS       EE,
                BANCO.EST_ENTRADAS_ITENS EI,
                BANCO.EST_ENTRADAS_LOTES EL
          WHERE EL.SEQ_PLA_SAI_LOTE IS NOT NULL
            AND EE.SEQ_PLA_ENTRADA  = EI.SEQ_PLA_ENTRADA
            AND EI.SEQ_PLA_ENT_ITEM = EL.SEQ_PLA_ENT_ITEM
            AND EL.SEQ_PLA_LOTES    = LT.SEQ_PLA_LOTES
          GROUP BY LT.SEQ_PLA_CULTIVAR,
                   LT.SEQ_PLA_PENEIRA) DV,
       (SELECT EI.SEQ_PLA_CULTIVAR,
               EI.SEQ_PLA_PENEIRA,
               SUM(NVL(EI.QUANTIDADE,0)) AS TOTAL_ENTREGUE
          FROM BANCO.EST_SAIDAS_ITENS EI,
               BANCO.EST_SAIDAS       ES
         WHERE EI.SEQ_PLA_SAIDA      = ES.SEQ_PLA_SAIDA
           AND DECODE(ES.NR_AUTORIZA,NULL,'X',ES.NR_AUTORIZA) <> 'X'
           AND DECODE(ES.CANCELADO,NULL,'X',ES.CANCELADO) <> 'S'
         GROUP BY EI.SEQ_PLA_CULTIVAR,EI.SEQ_PLA_PENEIRA) TE,
       (SELECT UBS_Lotes.Seq_Pla_Cultivar,
               UBS_Lotes.Seq_Pla_Peneira,
               SUM(NVL(UBS_Lotes.QTDE_SACAS,0)) as TOTAL_PRODUZIDO,
               SUM(SA.QUANTIDADE) AS QTD_SACAS_AVARIADAS
          FROM BANCO.UBS_Lotes,
               MARCA_PRODUTO,
               (SELECT SEQ_PLA_LOTES,SUM(NVL(QUANTIDADE,0)) AS QUANTIDADE
                  FROM BANCO.UBS_SACARIAS_AVARIADAS
                 GROUP BY SEQ_PLA_LOTES) SA
        WHERE UBS_Lotes.SEQ_PLA_LOTES = SA.SEQ_PLA_LOTES(+)
      AND UBS_Lotes.SEQ_PLA_MARCA = MARCA_PRODUTO.SEQ_PLA_MARCA
       GROUP BY SEQ_PLA_CULTIVAR, SEQ_PLA_PENEIRA) TP,
       (SELECT PV.COD_EMPRESA,
               PV.COD_FILIAL_ENTREGA AS COD_FILIAL_PEDIDO,
               RI.SEQ_PLA_CULTIVAR,
               RI.SEQ_PLA_PENEIRA,
               SUM(NVL(RI.QUANTIDADE,0))  AS TOTAL_VENDIDO,
               SUM(nvl(RI.QUANTIDADE_ACERTO,0)) AS QUANTIDADE_ACERTO
          FROM BANCO.SEM_PEDIDOS_VENDA_ITENS  RI,
               BANCO.SEM_PEDIDOS_VENDA        PV,
               BANCO.CLIENTES_ENDERECOS       CE,
               BANCO.REGIOES                  RE,
               BANCO.CIDADES                  CD
         WHERE RI.SEQ_PLA_PED_VENDA_SEM = PV.SEQ_PLA_PED_VENDA_SEM
           AND NVL(PV.AUX_PEDIDO,0) = 0
           AND PV.TIPO_OPERACAO='V'
           AND DECODE(PV.CANCELADO,NULL,'N',PV.CANCELADO)<>'S'
           AND PV.SEQ_PLA_ENDERECO = CE.SEQ_PLA_ENDERECO (+)
           AND CE.SEQ_PLA_CIDADES = CD.SEQ_PLA_CIDADES   (+)
           AND CD.SEQ_PLA_REGIOES = RE.SEQ_PLA_REGIOES   (+)
         GROUP BY PV.COD_EMPRESA,PV.COD_FILIAL_ENTREGA,RI.SEQ_PLA_CULTIVAR,RI.SEQ_PLA_PENEIRA) TV,
       (SELECT SEQ_PLA_CULTIVAR,
               SEQ_PLA_PENEIRA,
               SUM(NVL(QUANTIDADE,0))  AS TOTAL_COMPRADO
          FROM BANCO.SEM_PEDIDOS_COMPRA_ITENS RI,
               BANCO.SEM_PEDIDOS_COMPRA       PC
         WHERE RI.SEQ_PLA_PED_COMPRA = PC.SEQ_PLA_PED_COMPRA
        GROUP BY SEQ_PLA_CULTIVAR,SEQ_PLA_PENEIRA) TC,
       (SELECT SEQ_PLA_CULTIVAR,
               SEQ_PLA_PENEIRA,
               SUM(NVL(QUANTIDADE,0))  AS TOTAL_RESERVADO
          FROM BANCO.SEM_RESERVA_ITENS        RI,
               BANCO.SEM_RESERVA              PR
         WHERE RI.SEQ_PLA_SEM_RESERVA = PR.SEQ_PLA_SEM_RESERVA
        GROUP BY SEQ_PLA_CULTIVAR,SEQ_PLA_PENEIRA) TR
 WHERE ((TP.TOTAL_PRODUZIDO > 0) OR
        (TC.TOTAL_COMPRADO  > 0) OR
        (TV.TOTAL_VENDIDO   > 0) OR
        (TR.TOTAL_RESERVADO > 0))
   AND CV.SEQ_PLA_PRODUTO   = PR.SEQ_PLA_PRODUTO(+)
   AND CV.SEQ_PLA_UNIDADE   = UN.SEQ_PLA_UNIDADE(+)
   AND CV.SEQ_PLA_VARIEDADE = VR.SEQ_PLA_VARIEDADE(+)
   AND CV.SEQ_PLA_CLASSE    = CL.SEQ_PLA_CLASSE(+)
   AND CV.SEQ_PLA_CULTIVAR  = TSP.SEQ_PLA_CULTIVAR(+)
   AND CV.SEQ_PLA_PENEIRA   = TSP.SEQ_PLA_PENEIRA(+)
   AND CV.SEQ_PLA_CULTIVAR  = TE.SEQ_PLA_CULTIVAR(+)
   AND CV.SEQ_PLA_PENEIRA   = TE.SEQ_PLA_PENEIRA(+)
   AND CV.SEQ_PLA_CULTIVAR  = TP.SEQ_PLA_CULTIVAR(+)
   AND CV.SEQ_PLA_PENEIRA   = TP.SEQ_PLA_PENEIRA(+)
   AND CV.SEQ_PLA_CULTIVAR  = TV.SEQ_PLA_CULTIVAR(+)
   AND CV.SEQ_PLA_PENEIRA   = TV.SEQ_PLA_PENEIRA(+)
   AND CV.COD_EMPRESA       = TV.COD_EMPRESA(+)
   AND CV.COD_FILIAL        = TV.COD_FILIAL_PEDIDO(+)
   AND CV.SEQ_PLA_CULTIVAR  = TC.SEQ_PLA_CULTIVAR(+)
   AND CV.SEQ_PLA_PENEIRA   = TC.SEQ_PLA_PENEIRA(+)
   AND CV.SEQ_PLA_CULTIVAR  = TR.SEQ_PLA_CULTIVAR(+)
   AND CV.SEQ_PLA_PENEIRA   = TR.SEQ_PLA_PENEIRA(+)
   AND CV.SEQ_PLA_CULTIVAR  = DV.SEQ_PLA_CULTIVAR(+)
   AND CV.SEQ_PLA_PENEIRA   = DV.SEQ_PLA_PENEIRA(+)
   AND PR.SEQ_PLA_PRODUTO   = TCC.SEQ_PLA_PRODUTO (+)
   AND PR.SEQ_PLA_MARCA     = MP.SEQ_PLA_MARCA (+)
   AND CV.COD_EMPRESA       = EMP.COD_EMPRESA
   AND CV.COD_SAFRA         = SAF.COD_SAFRA
   AND CV.COD_FILIAL        = FIL.COD_FILIAL
   AND CV.COD_EMPRESA       = FIL.COD_EMPRESA
   AND UNKG.SIGLA_UNIDADE   = 'KG'
   --AND CV.COD_SAFRA         = 8
   --AND CV.COD_EMPRESA       = 3
   --AND CV.COD_FILIAL        = 1;
