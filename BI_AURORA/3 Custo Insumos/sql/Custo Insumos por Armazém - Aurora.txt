--PRINCIPAL
SELECT AB.ARMAZEM, AB.DESCRICAO_GRUPO, AB.ARMAZEM|| ' : ' ||AB.DESCRICAO_GRUPO AGRUPADOR, SUM(AB.ESTOQUE) ESTOQUE,
       SUM(AB.ESTOQUE * AB.CALC_CUSTO_MEDIO) AS CUSTO_MEDIO_TOTAL
  FROM (SELECT AA.DESC_ARMAZEM AS ARMAZEM,  GR.DESCRICAO_GRUPO,
               AGRICOLA.CalcCustoMedioArmazem('ME', AA.SEQ_PLA_ARMAZEM, AA.SEQ_PLA_PRODUTO ,NVL(:COD_SAFRA_STRING,'15'),NVL(:COD_EMPRESA_STRING,'1'),'',TO_DATE( :DATAB_DATA ,'DD/MM/RRRR')) AS CALC_CUSTO_MEDIO,               
               AA.ESTOQUE
          FROM AGRICOLA.PRODUTOS        PR,
               AGRICOLA.SUB_GRUPO       SG,
               AGRICOLA.GRUPO           GR,
               AGRICOLA.UNIDADE_PRODUTO UN,
               (SELECT A.DESC_ARMAZEM,  A.DESCRICAO_GRUPO, A.SEQ_PLA_PRODUTO, A.SEQ_PLA_ARMAZEM,
                       (SUM(A.ESTOQUE_INICIAL)+SUM(A.ENTRADAS)-SUM(A.SAIDAS)) AS ESTOQUE
                  FROM VW_CONSULTA_ESTOQUE_ARMAZEM A
                 WHERE 1=1
                   AND TO_CHAR(A.COD_EMPRESA) LIKE TO_CHAR(DECODE( NVL(:COD_EMPRESA_STRING,'0') ,'0','%', :COD_EMPRESA_STRING ))
                   AND A.ANO_SALDO IN (SELECT ANO_SALDO FROM AGRICOLA.SAFRAS WHERE TO_CHAR(COD_SAFRA) LIKE TO_CHAR(NVL(:COD_SAFRA_STRING , '15')))
                   &GRUPOPROD --AND A.SEQ_PLA_GRUPO IN ({GRUPOPROD})
                   AND TO_DATE(TRUNC(A.DATA),'DD/MM/RRRR') <= TO_DATE( :DATAB_DATA ,'DD/MM/RRRR')

                 GROUP BY  A.DESC_ARMAZEM,  A.DESCRICAO_GRUPO, A.SEQ_PLA_PRODUTO, A.SEQ_PLA_ARMAZEM
               ) AA
         WHERE PR.SEQ_PLA_PRODUTO    = AA.SEQ_PLA_PRODUTO
           AND PR.SEQ_PLA_SUB_GRUPO  = SG.SEQ_PLA_SUB_GRUPO
           AND SG.SEQ_PLA_GRUPO      = GR.SEQ_PLA_GRUPO
           AND PR.SEQ_PLA_UNIDADE    = UN.SEQ_PLA_UNIDADE
           AND DECODE(PR.SERVICO,NULL,'N',PR.SERVICO) = 'N'
       ) AB
 WHERE AB.ESTOQUE <> 0
   AND (AB.ESTOQUE * AB.CALC_CUSTO_MEDIO) <> 0
 GROUP BY AB.ARMAZEM, AB.DESCRICAO_GRUPO   
 ORDER BY AB.ARMAZEM, AB.DESCRICAO_GRUPO
